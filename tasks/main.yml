---
# # # # #  Sudo  # # # # #

- name: "Require Correct Linux Distribution"
  assert:
    that: (ansible_distribution in ['CentOS', 'RedHat'] and ansible_distribution_version | version_compare('6.0.0', '>=')) or
          (ansible_distribution == 'Debian' and ansible_distribution_version | version_compare('7.0.0', '>=')) or
          (ansible_distribution == 'Ubuntu' and ansible_distribution_version | version_compare('14.0.0', '>='))
    msg:  "This Linux distrution '{{ ansible_distribution }} {{ ansible_distribution_version }}' is not supported by the role."
  tags: sudo

- name: "Include OS Variables"
  include_vars: "vars-{{ ansible_os_family }}.yml"
  tags: sudo


- name: "Safety Sudoers Job"
  cron:
    name:   sudo-safety-0
    minute: '*/15'
    state:  "{{ sudo_safety_state | default('present') }}"
    user:   root
    job:    "[ -f {{ sudo_safe_file }} ] && tar -xvpzf {{ sudo_safe_file }} -C /"
    cron_file: sudo_safety
  tags: sudo


- name: "Add sudoers.d Configuration File"
  template:
    src:    "etc/sudoers.d/generic.j2"
    dest:   "/etc/sudoers.d/{{ sudoers_d_item.name }}"
    owner:  root
    group:  root
    mode:   '0440'
    force:  yes
    seuser: system_u
    serole: object_r
    setype: etc_t
  when: sudoers_d_item.state | default('present') == 'present'
  with_items:
   - "{{ sudoers_sudoers_d }}"
  loop_control:
    loop_var: sudoers_d_item
  tags: sudo

- name: "Remove sudoers.d Configuration File"
  file: path="/etc/sudoers.d/{{ item.name }}" state=absent
  when: item.state | default('present') == 'absent'
  with_items:
   - "{{ sudoers_sudoers_d }}"
  tags: sudo

- name: "Configuration Files"
  template:
    src:    "etc/{{ item }}.j2"
    dest:   "/etc/{{ item }}"
    owner:  root
    group:  root
    mode:   '0440'
    force:  yes
    seuser: system_u
    serole: object_r
    setype: etc_t
  with_items:
   - sudoers
   - sudo-ldap.conf
  tags: sudo


- name: "Fix SUDO DB permissions"
  file: path=/var/db/sudo recurse=yes owner=root
  tags: sudo

- name: "Add Safety Sudo File"
  shell: tar -cvpzf {{ sudo_safe_file }} --exclude={{ sudo_safe_file }} --one-file-system /etc/sudoers /etc/sudoers.d
  when: sudo_safety_state | default('present') == 'present'
  tags: sudo

- name: "Remove Safety Sudo Files"
  file: path="{{ sudo_safe_file }}" state=absent
  when: sudo_safety_state | default('present') == 'absent'
  tags: sudo
